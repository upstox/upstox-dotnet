/*
 * OpenAPI definition
 *
 * No description provided (generated by Openapi Generator https://github.com/openapitools/openapi-generator)
 *
 * The version of the OpenAPI document: v0
 * Generated by: https://github.com/openapitools/openapi-generator.git
 */

#nullable enable

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text.Json;
using System.Text.Json.Serialization;
using System.Net.Http;
using Microsoft.Extensions.DependencyInjection;
using UpstoxClient.Api;
using UpstoxClient.Model;

namespace UpstoxClient.Client
{
    /// <summary>
    /// Provides hosting configuration for UpstoxClient
    /// </summary>
    public class HostConfiguration
    {
        private readonly IServiceCollection _services;
        private readonly JsonSerializerOptions _jsonOptions = new JsonSerializerOptions();
        private bool? _sandbox;

        internal bool HttpClientsAdded { get; private set; }

        /// <summary>
        /// Instantiates the class 
        /// </summary>
        /// <param name="services"></param>
        public HostConfiguration(IServiceCollection services)
        {
            _services = services;
            _jsonOptions.Converters.Add(new JsonStringEnumConverter());
            _jsonOptions.Converters.Add(new DateTimeJsonConverter());
            _jsonOptions.Converters.Add(new DateTimeNullableJsonConverter());
            _jsonOptions.Converters.Add(new DateOnlyJsonConverter());
            _jsonOptions.Converters.Add(new DateOnlyNullableJsonConverter());
            _jsonOptions.Converters.Add(new AnalyticsDataJsonConverter());
            _jsonOptions.Converters.Add(new ApiGatewayErrorResponseJsonConverter());
            _jsonOptions.Converters.Add(new BatchExecutionSummaryJsonConverter());
            _jsonOptions.Converters.Add(new BrokerageDataJsonConverter());
            _jsonOptions.Converters.Add(new BrokerageTaxesJsonConverter());
            _jsonOptions.Converters.Add(new BrokerageWrapperDataJsonConverter());
            _jsonOptions.Converters.Add(new CancelOrExitMultiOrderDataJsonConverter());
            _jsonOptions.Converters.Add(new CancelOrExitMultiOrderResponseJsonConverter());
            _jsonOptions.Converters.Add(new CancelOrExitOrderErrorDataJsonConverter());
            _jsonOptions.Converters.Add(new CancelOrderDataJsonConverter());
            _jsonOptions.Converters.Add(new CancelOrderResponseJsonConverter());
            _jsonOptions.Converters.Add(new CancelOrderV3ResponseJsonConverter());
            _jsonOptions.Converters.Add(new ConvertPositionDataJsonConverter());
            _jsonOptions.Converters.Add(new ConvertPositionRequestJsonConverter());
            _jsonOptions.Converters.Add(new ConvertPositionResponseJsonConverter());
            _jsonOptions.Converters.Add(new DepthJsonConverter());
            _jsonOptions.Converters.Add(new DepthMapJsonConverter());
            _jsonOptions.Converters.Add(new DpPlanJsonConverter());
            _jsonOptions.Converters.Add(new ExchangeTimingDataJsonConverter());
            _jsonOptions.Converters.Add(new ExpiredFutureDataJsonConverter());
            _jsonOptions.Converters.Add(new GetBrokerageResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetExchangeTimingResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetExpiredFuturesContractResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetExpiriesResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetFullMarketQuoteResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetGttOrderResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetHistoricalCandleResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetHoldingsResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetHolidayResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetIntraDayCandleResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetMarketQuoteLastTradedPriceResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetMarketQuoteLastTradedPriceResponseV3JsonConverter());
            _jsonOptions.Converters.Add(new GetMarketQuoteOHLCResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetMarketQuoteOHLCResponseV3JsonConverter());
            _jsonOptions.Converters.Add(new GetMarketQuoteOptionGreekResponseV3JsonConverter());
            _jsonOptions.Converters.Add(new GetMarketStatusResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetOptionChainResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetOptionContractResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetOrderBookResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetOrderDetailsResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetOrderResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetPositionResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetProfileResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetProfitAndLossChargesResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetTradeResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetTradeWiseProfitAndLossDataResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetTradeWiseProfitAndLossMetaDataResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetUserFundMarginResponseJsonConverter());
            _jsonOptions.Converters.Add(new GttCancelOrderRequestJsonConverter());
            _jsonOptions.Converters.Add(new GttModifyOrderRequestJsonConverter());
            _jsonOptions.Converters.Add(new GttOrderDataJsonConverter());
            _jsonOptions.Converters.Add(new GttOrderDetailsJsonConverter());
            _jsonOptions.Converters.Add(new GttPlaceOrderRequestJsonConverter());
            _jsonOptions.Converters.Add(new GttRuleJsonConverter());
            _jsonOptions.Converters.Add(new GttTriggerOrderResponseJsonConverter());
            _jsonOptions.Converters.Add(new HistoricalCandleDataJsonConverter());
            _jsonOptions.Converters.Add(new HoldingsDataJsonConverter());
            _jsonOptions.Converters.Add(new HolidayDataJsonConverter());
            _jsonOptions.Converters.Add(new IndieUserInitTokenDataJsonConverter());
            _jsonOptions.Converters.Add(new IndieUserInitTokenResponseJsonConverter());
            _jsonOptions.Converters.Add(new IndieUserTokenRequestJsonConverter());
            _jsonOptions.Converters.Add(new InstrumentJsonConverter());
            _jsonOptions.Converters.Add(new InstrumentDataJsonConverter());
            _jsonOptions.Converters.Add(new IntraDayCandleDataJsonConverter());
            _jsonOptions.Converters.Add(new LogoutResponseJsonConverter());
            _jsonOptions.Converters.Add(new MarginJsonConverter());
            _jsonOptions.Converters.Add(new MarginDataJsonConverter());
            _jsonOptions.Converters.Add(new MarginRequestJsonConverter());
            _jsonOptions.Converters.Add(new MarketDataJsonConverter());
            _jsonOptions.Converters.Add(new MarketQuoteOHLCJsonConverter());
            _jsonOptions.Converters.Add(new MarketQuoteOHLCV3JsonConverter());
            _jsonOptions.Converters.Add(new MarketQuoteOptionGreekV3JsonConverter());
            _jsonOptions.Converters.Add(new MarketQuoteSymbolJsonConverter());
            _jsonOptions.Converters.Add(new MarketQuoteSymbolLtpJsonConverter());
            _jsonOptions.Converters.Add(new MarketQuoteSymbolLtpV3JsonConverter());
            _jsonOptions.Converters.Add(new MarketStatusDataJsonConverter());
            _jsonOptions.Converters.Add(new ModifyOrderDataJsonConverter());
            _jsonOptions.Converters.Add(new ModifyOrderRequestJsonConverter());
            _jsonOptions.Converters.Add(new ModifyOrderResponseJsonConverter());
            _jsonOptions.Converters.Add(new ModifyOrderV3ResponseJsonConverter());
            _jsonOptions.Converters.Add(new MultiOrderDataJsonConverter());
            _jsonOptions.Converters.Add(new MultiOrderErrorJsonConverter());
            _jsonOptions.Converters.Add(new MultiOrderRequestJsonConverter());
            _jsonOptions.Converters.Add(new MultiOrderResponseJsonConverter());
            _jsonOptions.Converters.Add(new MultiOrderSummaryJsonConverter());
            _jsonOptions.Converters.Add(new MultiOrderV3DataJsonConverter());
            _jsonOptions.Converters.Add(new OAuthClientExceptionJsonConverter());
            _jsonOptions.Converters.Add(new OAuthClientExceptionCauseJsonConverter());
            _jsonOptions.Converters.Add(new OAuthClientExceptionCauseStackTraceInnerJsonConverter());
            _jsonOptions.Converters.Add(new OhlcJsonConverter());
            _jsonOptions.Converters.Add(new OhlcV3JsonConverter());
            _jsonOptions.Converters.Add(new OptionStrikeDataJsonConverter());
            _jsonOptions.Converters.Add(new OrderBookDataJsonConverter());
            _jsonOptions.Converters.Add(new OrderDataJsonConverter());
            _jsonOptions.Converters.Add(new OrderMetadataJsonConverter());
            _jsonOptions.Converters.Add(new OtherTaxesJsonConverter());
            _jsonOptions.Converters.Add(new PlaceOrderDataJsonConverter());
            _jsonOptions.Converters.Add(new PlaceOrderRequestJsonConverter());
            _jsonOptions.Converters.Add(new PlaceOrderResponseJsonConverter());
            _jsonOptions.Converters.Add(new PlaceOrderV3RequestJsonConverter());
            _jsonOptions.Converters.Add(new PlaceOrderV3ResponseJsonConverter());
            _jsonOptions.Converters.Add(new PositionDataJsonConverter());
            _jsonOptions.Converters.Add(new PostMarginResponseJsonConverter());
            _jsonOptions.Converters.Add(new ProblemJsonConverter());
            _jsonOptions.Converters.Add(new ProfileDataJsonConverter());
            _jsonOptions.Converters.Add(new ProfitAndLossChargesDataJsonConverter());
            _jsonOptions.Converters.Add(new ProfitAndLossChargesTaxesJsonConverter());
            _jsonOptions.Converters.Add(new ProfitAndLossChargesWrapperDataJsonConverter());
            _jsonOptions.Converters.Add(new ProfitAndLossMetaDataJsonConverter());
            _jsonOptions.Converters.Add(new ProfitAndLossMetaDataWrapperJsonConverter());
            _jsonOptions.Converters.Add(new ProfitAndLossOtherChargesTaxesJsonConverter());
            _jsonOptions.Converters.Add(new PutCallOptionChainDataJsonConverter());
            _jsonOptions.Converters.Add(new RuleJsonConverter());
            _jsonOptions.Converters.Add(new TokenResponseJsonConverter());
            _jsonOptions.Converters.Add(new TradeDataJsonConverter());
            _jsonOptions.Converters.Add(new TradeHistoryResponseJsonConverter());
            _jsonOptions.Converters.Add(new TradeHistoryResponseMetaDataJsonConverter());
            _jsonOptions.Converters.Add(new TradeHistoryResponsePageDataJsonConverter());
            _jsonOptions.Converters.Add(new TradeHistoryResponseTradeDataJsonConverter());
            _jsonOptions.Converters.Add(new TradeWiseMetaDataJsonConverter());
            _jsonOptions.Converters.Add(new TradeWiseProfitAndLossDataJsonConverter());
            _jsonOptions.Converters.Add(new UserFundMarginDataJsonConverter());
            _jsonOptions.Converters.Add(new WebsocketAuthRedirectResponseJsonConverter());
            _jsonOptions.Converters.Add(new WebsocketAuthRedirectResponseDataJsonConverter());
            JsonSerializerOptionsProvider jsonSerializerOptionsProvider = new(_jsonOptions);
            _services.AddSingleton(jsonSerializerOptionsProvider);
            _services.AddSingleton<IApiFactory, ApiFactory>();
            _services.AddSingleton<ChargeApiEvents>();
            _services.AddSingleton<ExpiredInstrumentApiEvents>();
            _services.AddSingleton<HistoryV3ApiEvents>();
            _services.AddSingleton<LoginApiEvents>();
            _services.AddSingleton<MarketHolidaysAndTimingsApiEvents>();
            _services.AddSingleton<MarketQuoteApiEvents>();
            _services.AddSingleton<MarketQuoteV3ApiEvents>();
            _services.AddSingleton<OptionsApiEvents>();
            _services.AddSingleton<OrderApiEvents>();
            _services.AddSingleton<OrderV3ApiEvents>();
            _services.AddSingleton<PortfolioApiEvents>();
            _services.AddSingleton<PostTradeApiEvents>();
            _services.AddSingleton<TradeProfitAndLossApiEvents>();
            _services.AddSingleton<UserApiEvents>();
            _services.AddSingleton<WebsocketApiEvents>();
        }

        /// <summary>
        /// Configures the HttpClients.
        /// </summary>
        /// <param name="client"></param>
        /// <param name="builder"></param>
        /// <returns></returns>
        public HostConfiguration AddApiHttpClients
        (
            Action<HttpClient>? client = null, Action<IHttpClientBuilder>? builder = null)
        {
            // Register sandbox configuration
            _services.AddSingleton<ISandboxConfiguration>(new SandboxConfiguration(Sandbox));

            if (client == null)
                client = c => c.BaseAddress = new Uri(ClientUtils.BASE_ADDRESS);

            List<IHttpClientBuilder> builders = new List<IHttpClientBuilder>();

            // Configure OrderV3Api and OrderApi with sandbox URL if sandbox mode is enabled
            var sandboxBaseUrl = Sandbox ? "https://api-sandbox.upstox.com" : ClientUtils.BASE_ADDRESS;
            var sandboxClient = Sandbox ? (c => c.BaseAddress = new Uri(sandboxBaseUrl)) : client;

            builders.Add(_services.AddHttpClient<IOrderApi, OrderApi>(sandboxClient));
            builders.Add(_services.AddHttpClient<IOrderV3Api, OrderV3Api>(sandboxClient));

            // Configure other APIs with default URL
            builders.Add(_services.AddHttpClient<IChargeApi, ChargeApi>(client));
            builders.Add(_services.AddHttpClient<IExpiredInstrumentApi, ExpiredInstrumentApi>(client));
            builders.Add(_services.AddHttpClient<IHistoryV3Api, HistoryV3Api>(client));
            builders.Add(_services.AddHttpClient<ILoginApi, LoginApi>(client));
            builders.Add(_services.AddHttpClient<IMarketHolidaysAndTimingsApi, MarketHolidaysAndTimingsApi>(client));
            builders.Add(_services.AddHttpClient<IMarketQuoteApi, MarketQuoteApi>(client));
            builders.Add(_services.AddHttpClient<IMarketQuoteV3Api, MarketQuoteV3Api>(client));
            builders.Add(_services.AddHttpClient<IOptionsApi, OptionsApi>(client));
            builders.Add(_services.AddHttpClient<IPortfolioApi, PortfolioApi>(client));
            builders.Add(_services.AddHttpClient<IPostTradeApi, PostTradeApi>(client));
            builders.Add(_services.AddHttpClient<ITradeProfitAndLossApi, TradeProfitAndLossApi>(client));
            builders.Add(_services.AddHttpClient<IUserApi, UserApi>(client));
            builders.Add(_services.AddHttpClient<IWebsocketApi, WebsocketApi>(client));
            
            if (builder != null)
                foreach (IHttpClientBuilder instance in builders)
                    builder(instance);

            HttpClientsAdded = true;

            return this;
        }

        /// <summary>
        /// Configures the JsonSerializerSettings
        /// </summary>
        /// <param name="options"></param>
        /// <returns></returns>
        public HostConfiguration ConfigureJsonOptions(Action<JsonSerializerOptions> options)
        {
            options(_jsonOptions);

            return this;
        }

        /// <summary>
        /// Adds tokens to your IServiceCollection
        /// </summary>
        /// <typeparam name="TTokenBase"></typeparam>
        /// <param name="token"></param>
        /// <returns></returns>
        public HostConfiguration AddTokens<TTokenBase>(TTokenBase token) where TTokenBase : TokenBase
        {
            return AddTokens(new TTokenBase[]{ token });
        }

        /// <summary>
        /// Adds tokens to your IServiceCollection
        /// </summary>
        /// <typeparam name="TTokenBase"></typeparam>
        /// <param name="tokens"></param>
        /// <returns></returns>
        public HostConfiguration AddTokens<TTokenBase>(IEnumerable<TTokenBase> tokens) where TTokenBase : TokenBase
        {
            TokenContainer<TTokenBase> container = new TokenContainer<TTokenBase>(tokens);
            _services.AddSingleton(services => container);

            return this;
        }

        /// <summary>
        /// Gets or sets whether sandbox mode is enabled
        /// </summary>
        public bool Sandbox
        {
            get => _sandbox ?? false;
            set
            {
                if (_sandbox.HasValue)
                {
                    throw new InvalidOperationException("Sandbox mode cannot be changed after it has been set.");
                }
                _sandbox = value;
            }
        }

        /// <summary>
        /// Adds a token provider to your IServiceCollection
        /// </summary>
        /// <typeparam name="TTokenProvider"></typeparam>
        /// <typeparam name="TTokenBase"></typeparam>
        /// <returns></returns>
        public HostConfiguration UseProvider<TTokenProvider, TTokenBase>()
            where TTokenProvider : TokenProvider<TTokenBase>
            where TTokenBase : TokenBase
        {
            _services.AddSingleton<TTokenProvider>();
            _services.AddSingleton<TokenProvider<TTokenBase>>(services => services.GetRequiredService<TTokenProvider>());

            return this;
        }
    }
}
